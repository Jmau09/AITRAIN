<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfil - AiTrain</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* -------------------- ESTILOS -------------------- */
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
body{display:flex;min-height:100vh;background:#0d0d0d;color:#fff;}
.sidebar{width:260px;background:#141414;display:flex;flex-direction:column;padding:25px;border-right:2px solid #ef4444;box-shadow:4px 0 15px rgba(239,68,68,0.15);}
.logo{width:150px;margin:0 auto 25px auto;cursor:pointer;border-radius:15px;transition:transform .2s;}
.logo:hover{transform:scale(1.06);}
.sidebar h2{color:#ef4444;margin-bottom:20px;font-size:20px;text-align:center;font-weight:700;}
.sidebar button{background:none;border:none;color:#fff;text-align:left;padding:12px 14px;font-size:15px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:12px;border-radius:8px;transition:all 0.2s;}
.sidebar button:hover,.sidebar button.active{background:#222;color:#ef4444;transform:translateX(5px);}
.main-content{flex:1;padding:40px;}
section{display:none;}
section.active{display:flex;flex-direction:column;align-items:center;gap:25px;}
.info-card{background:#1a1a1a;border:1px solid #ef4444;border-radius:15px;padding:30px;width:600px;box-shadow:0 0 15px rgba(239,68,68,0.20);animation:fadeIn .4s ease;}
.info-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;}
.info-header i{font-size:32px;color:#ef4444;}
.info-header h1{color:#ef4444;font-size:26px;margin:0;}
.info-row{margin-bottom:15px;font-size:16px;}
.info-row strong{color:#ef4444;font-weight:600;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
form{display:flex;flex-direction:column;gap:15px;margin-bottom:20px;}
label{font-size:14px;color:#fff;}
input,textarea,select{padding:10px;border-radius:8px;border:1px solid #ef4444;background:#1a1a1a;color:#fff;font-size:14px;outline:none;}
input:focus,textarea:focus,select:focus{border-color:#ff6b6b;box-shadow:0 0 5px rgba(239,68,68,0.5);}
button.submit-btn{padding:12px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s;background:#ef4444;color:#fff;}
button.submit-btn:hover{background:#cc0000;transform:scale(1.03);}
.valoracion-card{margin-top:10px;padding:25px;background:#1a1a1a;border:1px solid #ef4444;border-radius:15px;box-shadow:0 0 15px rgba(239,68,68,0.2);width:600px;}
.valoracion-card h2{margin-bottom:15px;color:#ef4444;display:flex;align-items:center;gap:10px;}
.valoracion-card p{margin:6px 0;font-size:15px;}
.valoracion-card strong{color:#ef4444 !important;}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <img src="brazo.png" class="logo" id="logoBtn" alt="AiTrain Logo">
  <h2>Mi Perfil</h2>
  <button id="btnInicio"><i class="fas fa-home"></i> Volver al inicio</button>
  <button class="active" data-target="info">Informaci√≥n Personal <i class="fas fa-user"></i></button>
  <button data-target="actualizar">Actualizar Datos <i class="fas fa-edit"></i></button>
  <button data-target="eliminar">Eliminar Cuenta <i class="fas fa-trash-alt"></i></button>
  <button data-target="valoracion">Registrar Valoraci√≥n <i class="fas fa-star"></i></button>
</div>

<!-- Main Content -->
<div class="main-content">
  <section id="info" class="active">
    <div class="info-card">
      <div class="info-header"><i class="fas fa-address-card"></i><h1>Informaci√≥n Personal</h1></div>
      <p class="info-row"><strong>Nombre Completo:</strong> <span id="nombreUsuario"></span></p>
      <p class="info-row"><strong>Correo:</strong> <span id="correoUsuario"></span></p>
      <p class="info-row"><strong>Tel√©fono:</strong> <span id="telefonoUsuario"></span></p>
      <p class="info-row"><strong>Edad:</strong> <span id="edadUsuario"></span></p>
    </div>
    <div class="valoracion-card">
      <h2 class="valoracion-title"><i class="fas fa-dumbbell"></i> √öltima Valoraci√≥n F√≠sica</h2>
      <p><strong>Peso:</strong> <span id="v_peso">‚Äî</span> kg</p>
      <p><strong>Estatura:</strong> <span id="v_estatura">‚Äî</span> cm</p>
      <p><strong>IMC:</strong> <span id="v_imc">‚Äî</span></p>
      <p><strong>G√©nero:</strong> <span id="v_genero">‚Äî</span></p>
      <p><strong>Edad:</strong> <span id="v_edad">‚Äî</span></p>
      <p><strong>Nivel Actividad:</strong> <span id="v_actividad">‚Äî</span></p>
      <p><strong>D√≠as Entrenamiento:</strong> <span id="v_dias">‚Äî</span></p>
      <p><strong>Tiempo por sesi√≥n:</strong> <span id="v_tiempo">‚Äî</span> min</p>
      <p><strong>Objetivo:</strong> <span id="v_objetivo">‚Äî</span></p>
    </div>
  </section>

  <section id="actualizar">
    <h1 style="color:#ef4444;">Actualizar Datos</h1>
    <form id="updateForm">
      <label>Nombre</label><input type="text" id="nombre" required>
      <label>Apellido</label><input type="text" id="apellido" required>
      <label>Tel√©fono</label><input type="text" id="telefono" required>
      <label>Edad</label><input type="number" id="edad" required min="1">
      <label>Contrase√±a</label><input type="password" id="password" required minlength="4">
      <button type="submit" class="submit-btn">Actualizar</button>
    </form>
  </section>

  <section id="eliminar">
    <h1 style="color:#ef4444;">Eliminar Cuenta</h1>
    <button id="btnEliminar" class="submit-btn"><i class="fas fa-trash-alt"></i> Eliminar mi cuenta</button>
  </section>

  <section id="valoracion">
    <h1>Registrar Valoraci√≥n F√≠sica</h1>
    <form id="valoracionForm">
      <label>Peso (kg)</label><input type="number" id="pesoKg" step="0.1" min="1" required>
      <label>Estatura (cm)</label><input type="number" id="estaturaCm" min="50" required>
      <label>G√©nero</label><select id="genero" required><option value="">Seleccione‚Ä¶</option><option value="M">Masculino</option><option value="F">Femenino</option></select>
      <label>Edad</label><input type="number" id="edadValoracion" min="1" required>
      <label>Nivel de Actividad</label><select id="nivelActividad" required><option value="">Seleccione‚Ä¶</option><option value="Sedentaria">Sedentaria</option><option value="Ligera">Ligera</option><option value="Moderada">Moderada</option><option value="Intensa">Intensa</option></select>
      <label>D√≠as de Entrenamiento por Semana</label><input type="number" id="diasEntrenamiento" min="1" max="7" required>
      <label>Tiempo por Sesi√≥n (min)</label><input type="number" id="tiempoPorSesionMin" min="10" required>
      <label>Objetivo</label><select id="objetivo" required>
        <option value="">Seleccione‚Ä¶</option>
        <option value="Perder grasa">Perder grasa</option>
        <option value="Ganar masa muscular">Ganar masa muscular</option>
        <option value="Mantener peso">Mantener peso</option>
        <option value="Mejorar resistencia">Mejorar resistencia</option>
        <option value="Aumentar fuerza">Aumentar fuerza</option>
        <option value="Acondicionamiento general">Acondicionamiento general</option>
      </select>
      <label>Restricciones</label><input type="text" id="restricciones" placeholder="Opcional">
      <label>Limitaciones</label><input type="text" id="limitaciones" placeholder="Opcional">
      <button type="submit" class="submit-btn">Guardar Valoraci√≥n</button>
      <div id="mensajeValoracion"></div>
    </form>
  </section>
</div>

<script type="module">
// üîπ Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, deleteUser, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAAwm2LHCPY5pn-CFq5x_gI9VFgkEt3elc",
  authDomain: "aitrain-4a720.firebaseapp.com",
  projectId: "aitrain-4a720",
  storageBucket: "aitrain-4a720.firebasestorage.app",
  messagingSenderId: "600939007220",
  appId: "1:600939007220:web:09d9c0f57c7b449f3062a1",
  measurementId: "G-YYDK02V0LC"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// üîπ Navegaci√≥n Sidebar
const sections = document.querySelectorAll("section");
const buttons = document.querySelectorAll(".sidebar button");
buttons.forEach(btn => btn.addEventListener("click", () => {
  buttons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  sections.forEach(sec => sec.classList.remove("active"));
  document.getElementById(btn.dataset.target)?.classList.add("active");
}));

document.getElementById("logoBtn").addEventListener("click",()=>window.location.href="dashboard_usuario.html");
document.getElementById("btnInicio").addEventListener("click",()=>window.location.href="dashboard_usuario.html");

// üîπ Cargar info usuario
async function cargarInfoUsuario() {
  const email = localStorage.getItem("aitrain_user");
  if(!email) return;
  try {
    const res = await fetch(`http://localhost:8080/api/aitrain/usuario/buscar/${email}`);
    const data = await res.json();
    document.getElementById("nombreUsuario").textContent = `${data.nombre || ''} ${data.apellido || ''}`;
    document.getElementById("correoUsuario").textContent = data.email || email;
    document.getElementById("telefonoUsuario").textContent = data.telefono || "‚Äî";
    document.getElementById("edadUsuario").textContent = data.edad || "‚Äî";
  } catch(e){ console.error(e); }
}
cargarInfoUsuario();

// üîπ Actualizar datos
document.getElementById("updateForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const email = localStorage.getItem("aitrain_user");
  if(!email) return;
  const data = {
    email,
    nombre: document.getElementById("nombre").value,
    apellido: document.getElementById("apellido").value,
    telefono: document.getElementById("telefono").value,
    password: document.getElementById("password").value,
    edad: parseInt(document.getElementById("edad").value)
  };
  try {
    await fetch("http://localhost:8080/api/aitrain/usuario/update", {method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    alert("Datos actualizados ‚úî");
    cargarInfoUsuario();
  } catch(e){ alert("Error al actualizar"); console.error(e); }
});

// üîπ Valoraciones
const mensajeValoracion = document.getElementById("mensajeValoracion");
document.getElementById("valoracionForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const email = localStorage.getItem("aitrain_user");
  if(!email){ mensajeValoracion.textContent="No se encontr√≥ el usuario"; mensajeValoracion.style.color="red"; return;}
  const peso = parseFloat(document.getElementById("pesoKg").value);
  const estaturaCm = parseFloat(document.getElementById("estaturaCm").value);
  const imc = +(peso / ((estaturaCm/100)**2)).toFixed(2);
  const data = {
    emailUsuario: email,
    pesoKg: peso,
    estaturaCm,
    genero: document.getElementById("genero").value,
    imc,
    edad: parseInt(document.getElementById("edadValoracion").value),
    nivelActividad: document.getElementById("nivelActividad").value,
    diasEntrenamiento: parseInt(document.getElementById("diasEntrenamiento").value),
    tiempoPorSesionMin: parseInt(document.getElementById("tiempoPorSesionMin").value),
    objetivo: document.getElementById("objetivo").value,
    restricciones: document.getElementById("restricciones").value || "Ninguna",
    limitaciones: document.getElementById("limitaciones").value || "Ninguna"
  };
  try {
    await fetch("http://localhost:8080/api/aitrain/valoracion/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    mensajeValoracion.textContent="Valoraci√≥n registrada ‚úî"; mensajeValoracion.style.color="#4ade80";
    document.getElementById("valoracionForm").reset();
  } catch(e){ mensajeValoracion.textContent="Error al guardar ‚ùå"; mensajeValoracion.style.color="red"; console.error(e); }
});

async function cargarValoracionUsuario(){
  const email = localStorage.getItem("aitrain_user"); if(!email) return;
  try {
    const res = await fetch(`http://localhost:8080/api/aitrain/valoracion/buscar/${email}`);
    if(!res.ok) throw new Error("No encontrada");
    const data = await res.json();
    const v = data.valoracion;
    document.getElementById("v_peso").textContent=v.pesoKg;
    document.getElementById("v_estatura").textContent=v.estaturaCm;
    document.getElementById("v_imc").textContent=v.imc.toFixed(2);
    document.getElementById("v_genero").textContent=v.genero;
    document.getElementById("v_edad").textContent=v.edad;
    document.getElementById("v_actividad").textContent=v.nivelActividad;
    document.getElementById("v_dias").textContent=v.diasEntrenamiento;
    document.getElementById("v_tiempo").textContent=v.tiempoPorSesionMin;
    document.getElementById("v_objetivo").textContent=v.objetivo;
  } catch(e){ console.error("No hay valoraciones todav√≠a."); }
}
cargarValoracionUsuario();

// üîπ Eliminar cuenta
document.getElementById("btnEliminar").addEventListener("click", async ()=>{
  const email = localStorage.getItem("aitrain_user"); if(!email) return alert("Usuario no encontrado");
  const confirmar = confirm("‚ö† ¬øEliminar cuenta?"); if(!confirmar) return;
  const password = prompt("Ingresa tu contrase√±a para confirmar:"); if(!password) return;
  try {
    const user = auth.currentUser;
    const cred = EmailAuthProvider.credential(email,password);
    await reauthenticateWithCredential(user,cred);
    await deleteUser(user);
    await fetch(`http://localhost:8080/api/aitrain/valoracion/eliminar/${email}`,{method:"DELETE"});
    await fetch(`http://localhost:8080/api/aitrain/usuario/eliminar/${email}`,{method:"DELETE"});
    localStorage.removeItem("aitrain_user");
    alert("Cuenta eliminada ‚úî");
    window.location.href="login.html";
  } catch(e){ alert("Error al eliminar cuenta ‚ùå"); console.error(e); }
});
</script>
</body>
</html>
