<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat AiTrain</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', Arial, Helvetica, sans-serif; }
body { background: #0d0d0d; color: #fff; height: 100vh; display: flex; flex-direction: column; }

/* NAVBAR */
.navbar{width:100%; background:#141414; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #ef4444;}
.nav-left{display:flex; gap:15px; align-items:center;}
.nav-left img{width:50px; cursor:pointer;}
.nav-left h2{color:#ef4444;}
.nav-right{display:flex; gap:20px;}
.nav-right button{background:none; border:none; color:#fff; font-size:17px; cursor:pointer; transition:0.2s;}
.nav-right button:hover{color:#ef4444;}

/* CHAT CONTAINER */
.chat-container { flex: 1; display: flex; flex-direction: column; max-width: 700px; margin: 20px auto; background: #141414; border-radius: 15px; box-shadow:0 0 20px rgba(239,68,68,0.3); overflow: hidden; }

/* CHAT HEADER */
.chat-header { background: #ef4444; padding: 15px; text-align: center; font-weight: 700; font-size: 20px; }

/* CHAT MESSAGES */
.chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
.message { padding: 10px 15px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
.message.bot { background: #1a1a1a; border-left: 4px solid #ef4444; align-self: flex-start; }
.message.user { background: #ef4444; color: #fff; align-self: flex-end; }

/* BUTTONS CONTAINER */
.buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 15px; border-top: 1px solid #222; background: #1a1a1a; }
.buttons-container button { padding: 10px 15px; background: #ef4444; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.buttons-container button:hover { background: #cc0000; transform: scale(1.05); }

/* CARDS RUTINA / PLAN */
.card { background: #1a1a1a; border: 1px solid #ef4444; border-radius: 12px; padding: 15px; box-shadow: 0 0 10px rgba(239,68,68,0.2); }
.card h3 { color: #ef4444; margin-bottom: 8px; }
.card ul { list-style: none; padding-left: 10px; }
.card ul li { margin-bottom: 5px; }

/* SCROLLBAR */
.chat-messages::-webkit-scrollbar { width: 8px; }
.chat-messages::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 4px; }

/* BOTONES FLOTANTES */
.quick-buttons{
  position: fixed; bottom: 20px; right: 20px; display:flex; flex-direction:column; gap:10px; z-index:999;
}
.quick-buttons button{
  background:#ef4444; color:#fff; border:none; padding:12px 20px; font-size:16px; border-radius:12px; cursor:pointer; display:flex; align-items:center; gap:10px; transition:0.2s;
}
.quick-buttons button:hover{ background:#cc0000; transform:scale(1.05); }

/* MODAL */
.modal{
  display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center;
}
.modal-content{
  background:#141414; padding:25px; border-radius:15px; width:90%; max-width:600px; max-height:80%; overflow-y:auto; position:relative; border:2px solid #ef4444;
}
.modal-content .close{
  position:absolute; top:10px; right:15px; font-size:25px; cursor:pointer; color:#ef4444;
}
.card-modal{ background:#1a1a1a; border:1px solid #ef4444; border-radius:12px; padding:15px; margin-bottom:15px; }
.card-modal h3{ color:#ef4444; margin-bottom:8px; }
.card-modal ul{ list-style:none; padding-left:10px; }
.card-modal ul li{ margin-bottom:5px; }
</style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-left">
    <img src="brazo.png" alt="logo" onclick="location.href='dashboard_usuario.html'">
    <h2>AiTrain Chat</h2>
  </div>
  <div class="nav-right">
    <button onclick="location.href='chat.html'"><i class="fas fa-robot"></i> Chatbot</button>
    <button onclick="location.href='perfil.html'"><i class="fas fa-user"></i> Perfil</button>
    <button onclick="cerrarSesion()"><i class="fas fa-door-open"></i> Cerrar sesi√≥n</button>
  </div>
</div>

<!-- CHAT CONTAINER -->
<div class="chat-container">
  <div class="chat-header">AiTrain Chat</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="buttons-container" id="buttonsContainer">
    <button id="btnValoracion">Ver mi Valoraci√≥n</button>
    <button id="btnGenerarRutina">Generar Rutina y Plan Alimenticio</button>
  </div>
</div>

<!-- BOTONES FLOTANTES -->
<div class="quick-buttons">
  <button id="btnUltimaRutina"><i class="fas fa-dumbbell"></i> Ver mi √öltima Rutina</button>
  <button id="btnUltimaAlimentacion"><i class="fas fa-apple-alt"></i> Ver mi √öltimo Plan Alimenticio</button>
</div>

<!-- MODAL -->
<div id="modalInfo" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const buttonsContainer = document.getElementById('buttonsContainer');
const userId = localStorage.getItem("aitrain_user") || "usuario@ejemplo.com";

// MODAL
const modal = document.getElementById("modalInfo");
const modalBody = document.getElementById("modalBody");
const spanClose = document.querySelector(".close");
spanClose.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if(e.target==modal) modal.style.display="none"; };
function mostrarModal(html){ modalBody.innerHTML = html; modal.style.display = "flex"; }

// AGREGAR MENSAJE
function addMessage(text, sender='bot'){
  const msg = document.createElement('div');
  msg.classList.add('message', sender);
  msg.innerHTML = text;
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// MENSAJE BIENVENIDA
addMessage('¬°Hola! Bienvenido a AiTrain. Estoy aqu√≠ para ayudarte a mejorar tu entrenamiento y alimentaci√≥n.');

// HELPER POST
async function postJson(url, body){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  let data;
  try{ data = await res.json(); } catch(e){ data = await res.text(); }
  if(!res.ok) throw new Error(data.mensaje || data || 'Error en la petici√≥n');
  return data;
}

// VER VALORACI√ìN
document.getElementById('btnValoracion').addEventListener('click', async ()=>{
  try{
    const res = await fetch(`http://localhost:8080/api/aitrain/valoracion/buscar/${userId}`);
    if(!res.ok) throw new Error('Error al obtener valoraci√≥n');
    const data = await res.json();
    if(data.valoracion){
      const v = data.valoracion;
      addMessage(`Tu valoraci√≥n: Peso = ${v.pesoKg} kg, Estatura = ${v.estaturaCm} cm, IMC = ${v.imc.toFixed(2)}`);
    } else addMessage('No se encontr√≥ valoraci√≥n para este usuario.');
  }catch(err){ addMessage('‚ö†Ô∏è No se pudo obtener tu valoraci√≥n.', 'bot'); console.error(err);}
});

// GENERAR RUTINA Y PLAN
// ESTADO DEL USUARIO PARA EL CHAT
let estadoChat = 'inicio'; // inicio, objetivo, dias, confirmar, generado
let objetivoUsuario = '';
let diasUsuario = 0;

// FRASES MOTIVADORAS
const frasesMotivadoras = [
  '¬°Vamos, t√∫ puedes! üí™',
  'Cada repetici√≥n te acerca a tu objetivo.',
  '¬°Entrena con constancia y ver√°s resultados!',
  'Hoy es un buen d√≠a para superarte.',
  '¬°No te rindas, tu esfuerzo vale!'
];

// MENSAJE INICIAL
addMessage('¬°Hola! Bienvenido a AiTrain. Para empezar, selecciona tu objetivo:');
mostrarOpcionesObjetivo();

// BOTONES DE OBJETIVO
function mostrarOpcionesObjetivo() {
  const objetivos = ['Definici√≥n', 'Volumen', 'Fuerza', 'Resistencia'];
  buttonsContainer.innerHTML = ''; // limpiar botones
  objetivos.forEach(obj => {
    const btn = document.createElement('button');
    btn.textContent = obj;
    btn.addEventListener('click', () => {
      objetivoUsuario = obj;
      addMessage(`‚úÖ Objetivo seleccionado: ${obj}`);
      addMessage(fraseAleatoria());
      estadoChat = 'dias';
      mostrarOpcionesDias();
    });
    buttonsContainer.appendChild(btn);
  });
}

// BOTONES DE D√çAS
function mostrarOpcionesDias() {
  addMessage('Perfecto, ahora selecciona cu√°ntos d√≠as a la semana quieres entrenar:');
  const dias = [1,2,3,4,5,6,7];
  buttonsContainer.innerHTML = '';
  dias.forEach(d => {
    const btn = document.createElement('button');
    btn.textContent = d;
    btn.addEventListener('click', () => {
      diasUsuario = d;
      addMessage(`‚úÖ D√≠as seleccionados: ${d}`);
      addMessage(fraseAleatoria());
      estadoChat = 'confirmar';
      mostrarBotonGenerar();
    });
    buttonsContainer.appendChild(btn);
  });
}

// BOT√ìN GENERAR PLAN Y RUTINA
function mostrarBotonGenerar() {
  buttonsContainer.innerHTML = '';
  const btn = document.createElement('button');
  btn.textContent = 'Generar Rutina y Plan Alimenticio';
  btn.addEventListener('click', generarRutinaPlanDinamico);
  buttonsContainer.appendChild(btn);
}

// FUNCION PARA ELEGIR FRASE ALEATORIA
function fraseAleatoria() {
  return frasesMotivadoras[Math.floor(Math.random() * frasesMotivadoras.length)];
}

// FUNCION PARA GENERAR RUTINA Y PLAN DINAMICO
async function generarRutinaPlanDinamico() {
  addMessage('‚åõ Generando tu rutina y plan alimenticio...');
  
  const rutina = generarRutina(objetivoUsuario, diasUsuario);
  const planAlimenticio = generarPlan(objetivoUsuario, diasUsuario);

  try {
    await postJson('http://localhost:8081/api/aitrain/rutinas/save', rutina);
    await postJson('http://localhost:8082/api/aitrain/nutricion/save', planAlimenticio);
    addMessage('‚úÖ Rutina y plan alimenticio generados exitosamente!');
    addMessage(fraseAleatoria());

    if(!document.getElementById('btnVerRutina')){
      const btnRutina = document.createElement('button');
      btnRutina.id='btnVerRutina'; btnRutina.textContent='Ver mi Rutina'; btnRutina.addEventListener('click', verRutina);
      const btnPlan = document.createElement('button');
      btnPlan.id='btnVerPlan'; btnPlan.textContent='Ver mi Plan Alimenticio'; btnPlan.addEventListener('click', verPlanAlimenticio);
      buttonsContainer.appendChild(btnRutina); 
      buttonsContainer.appendChild(btnPlan);
    }

  } catch(err) {
    addMessage(`‚ö†Ô∏è Error al generar rutina y plan: ${err.message}`, 'bot'); 
    console.error(err);
  }
}

// GENERADOR DIN√ÅMICO DE RUTINAS
function generarRutina(objetivo, dias) {
  const ejerciciosBase = {
    'Definici√≥n': ['Cardio', 'Burpees', 'Jumping Jacks', 'Plancha', 'Mountain Climbers', 'Saltar cuerda', 'Abdominales'],
    'Volumen': ['Press de banca', 'Sentadillas', 'Peso muerto', 'Dominadas', 'Curl b√≠ceps', 'Fondos triceps', 'Remo con barra'],
    'Fuerza': ['Sentadillas pesadas', 'Press militar', 'Peso muerto', 'Fondos triceps', 'Dominadas lastradas', 'Press banca inclinado'],
    'Resistencia': ['Correr', 'Saltos', 'Flexiones', 'Remo', 'Bicicleta est√°tica', 'Burpees', 'Plancha din√°mica']
  };

  const diasSemana = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
  let rutina = { userId, nombre:`Rutina ${objetivo}`, objetivo, duracionSemanas:4, fechaCreacion:new Date().toISOString().split('T')[0], dias:[] };

  for(let i=0;i<dias;i++){
    // seleccionar 3-5 ejercicios aleatorios diferentes cada d√≠a
    let listaEjercicios = ejerciciosBase[objetivo].sort(()=>0.5-Math.random()).slice(0, 3 + Math.floor(Math.random()*3));
    let ejercicios = listaEjercicios.map(e => ({
      nombre:e,
      series: 3 + Math.floor(Math.random()*3),
      repeticiones: 8 + Math.floor(Math.random()*8),
      tiempo: `${20 + Math.floor(Math.random()*40)}s`
    }));
    rutina.dias.push({ nombreDia: diasSemana[i], ejercicios });
  }
  return rutina;
}

// GENERADOR DIN√ÅMICO DE PLAN ALIMENTICIO
function generarPlan(objetivo, dias) {
  const comidasBase = {
    'Definici√≥n':[{"nombre":"Desayuno","descripcion":"Avena con frutas y yogurt","calorias":300+Math.floor(Math.random()*50)},
                  {"nombre":"Almuerzo","descripcion":"Pechuga de pollo con ensalada","calorias":450+Math.floor(Math.random()*100)}],
    'Volumen':[{"nombre":"Desayuno","descripcion":"Huevos con pan integral y avena","calorias":400+Math.floor(Math.random()*50)},
               {"nombre":"Almuerzo","descripcion":"Pollo con arroz y pasta","calorias":700+Math.floor(Math.random()*100)}],
    'Fuerza':[{"nombre":"Desayuno","descripcion":"Batido proteico con avena","calorias":350+Math.floor(Math.random()*50)},
              {"nombre":"Almuerzo","descripcion":"Carne con papas y verduras","calorias":650+Math.floor(Math.random()*100)}],
    'Resistencia':[{"nombre":"Desayuno","descripcion":"Frutas y yogurt","calorias":300+Math.floor(Math.random()*50)},
                   {"nombre":"Almuerzo","descripcion":"Pescado con quinoa y vegetales","calorias":550+Math.floor(Math.random()*100)}]
  };

  const diasSemana = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
  let plan = { userId, nombre:`Plan ${objetivo}`, objetivo, dias:[] };

  for(let i=0;i<dias;i++){
    // agregamos las comidas base, con peque√±as variaciones en calor√≠as
    const comidas = comidasBase[objetivo].map(c => ({
      nombre: c.nombre,
      descripcion: c.descripcion,
      calorias: c.calorias
    }));
    plan.dias.push({ nombreDia:diasSemana[i], comidas });
  }

  return plan;
}


// VER RUTINA
async function verRutina(){
  try{
    const res = await fetch(`http://localhost:8081/api/aitrain/rutinas/usuario/${userId}`);
    if(!res.ok) throw new Error('Error al obtener rutina');
    const data = await res.json();
    if(Array.isArray(data) && data.length>0){
      const ultima = data[data.length-1];
      let html = `<div class="card"><h3>üìã Tu Rutina</h3>`;
      ultima.dias.forEach(dia=>{
        html += `<strong>${dia.nombreDia}:</strong><ul>`;
        dia.ejercicios.forEach(e=>html+=`<li>${e.nombre}: ${e.series}x${e.repeticiones} (${e.tiempo})</li>`);
        html += `</ul>`;
      });
      html += `</div>`; addMessage(html);
    }else addMessage('No se encontr√≥ rutina para este usuario.', 'bot');
  }catch(err){ addMessage(`‚ö†Ô∏è Error al obtener rutina: ${err.message}`,'bot'); console.error(err);}
}

// VER PLAN ALIMENTICIO
async function verPlanAlimenticio(){
  try{
    const res = await fetch(`http://localhost:8082/api/aitrain/nutricion/usuario/${userId}`);
    if(!res.ok) throw new Error('Error al obtener plan alimenticio');
    const data = await res.json();
    if(Array.isArray(data) && data.length>0){
      const ultimo = data[data.length-1];
      let html = `<div class="card"><h3>ü•ó Tu Plan Alimenticio</h3>`;
      ultimo.dias.forEach(dia=>{
        html += `<strong>${dia.nombreDia}:</strong><ul>`;
        dia.comidas.forEach(c=>html+=`<li>${c.nombre}: ${c.descripcion} (${c.calorias} kcal)</li>`);
        html += `</ul>`;
      });
      html += `</div>`; addMessage(html);
    }else addMessage('No se encontr√≥ plan alimenticio para este usuario.', 'bot');
  }catch(err){ addMessage(`‚ö†Ô∏è Error al obtener plan: ${err.message}`,'bot'); console.error(err);}
}

// BOTONES FLOTANTES
document.getElementById("btnUltimaRutina").addEventListener("click", async ()=>{
  try{
    const res = await fetch(`http://localhost:8081/api/aitrain/rutinas/usuario/${userId}`);
    if(!res.ok) throw new Error('Error al obtener rutina');
    const data = await res.json();
    if(Array.isArray(data) && data.length>0){
      const ultima = data[data.length-1];
      let html = `<div class="card-modal"><h3>üìã Tu √öltima Rutina</h3>`;
      ultima.dias.forEach(dia=>{
        html += `<strong>${dia.nombreDia}:</strong><ul>`;
        dia.ejercicios.forEach(e=>html+=`<li>${e.nombre}: ${e.series}x${e.repeticiones} (${e.tiempo})</li>`);
        html += `</ul>`;
      });
      html += `</div>`;
      mostrarModal(html);
    }else mostrarModal('<p>No se encontr√≥ rutina para este usuario.</p>');
  }catch(err){ mostrarModal(`<p>‚ö† Error al obtener rutina: ${err.message}</p>`); console.error(err);}
});

document.getElementById("btnUltimaAlimentacion").addEventListener("click", async ()=>{
  try{
    const res = await fetch(`http://localhost:8082/api/aitrain/nutricion/usuario/${userId}`);
    if(!res.ok) throw new Error('Error al obtener plan alimenticio');
    const data = await res.json();
    if(Array.isArray(data) && data.length>0){
      const ultimo = data[data.length-1];
      let html = `<div class="card-modal"><h3>ü•ó Tu √öltimo Plan Alimenticio</h3>`;
      ultimo.dias.forEach(dia=>{
        html += `<strong>${dia.nombreDia}:</strong><ul>`;
        dia.comidas.forEach(c=>html+=`<li>${c.nombre}: ${c.descripcion} (${c.calorias} kcal)</li>`);
        html += `</ul>`;
      });
      html += `</div>`;
      mostrarModal(html);
    }else mostrarModal('<p>No se encontr√≥ plan alimenticio para este usuario.</p>');
  }catch(err){ mostrarModal(`<p>‚ö† Error al obtener plan: ${err.message}</p>`); console.error(err);}
});

// CERRAR SESI√ìN
function cerrarSesion(){ localStorage.removeItem("aitrain_user"); window.location.href="index.html"; }
</script>

</body>
</html>
